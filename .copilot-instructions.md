# Backend Copilot Instructions - RESTful Notes API

## Projektstruktur

```
restful-notes-user-session-backend/
├── server.js           # Express-Server Setup
├── config/
│   ├── database.js     # MariaDB Verbindung
│   └── session.js      # Session-Konfiguration
├── routes/
│   ├── auth.js        # Authentifizierung-Routen
│   └── todos.js       # Todo-CRUD Routen
├── middleware/
│   ├── auth.js        # Auth-Middleware
│   └── validation.js  # Input-Validierung
├── models/
│   ├── User.js        # User-Model
│   └── Todo.js        # Todo-Model
├── utils/
│   ├── bcrypt.js      # Passwort-Hashing
│   └── validation.js  # Validierungs-Hilfsfunktionen
└── migrations/
    └── init.sql       # Datenbank-Schema
```

## Technologie-Stack

### Core Dependencies
- **Express.js** - Web-Framework
- **express-session** - Session-Management
- **mariadb** - MariaDB-Driver
- **bcrypt** - Passwort-Hashing
- **cors** - Cross-Origin Resource Sharing
- **helmet** - Security-Headers

### Development Dependencies
- **nodemon** - Auto-Reload
- **dotenv** - Environment Variables

## API-Design Prinzipien

### 1. RESTful Endpoints
```
Auth:
- POST /api/auth/register  # Benutzer-Registrierung
- POST /api/auth/login     # Benutzer-Login
- POST /api/auth/logout    # Benutzer-Logout
- GET  /api/auth/session   # Session-Validierung
- POST /api/auth/guest     # Gast-Session starten
- DELETE /api/auth/guest   # Gast-Session beenden

Todos:
- GET    /api/todos        # Alle Todos
- GET    /api/todos/:id    # Einzelnes Todo
- POST   /api/todos        # Neues Todo
- PUT    /api/todos/:id    # Todo aktualisieren
- DELETE /api/todos/:id    # Todo löschen
```

### 2. Session-Management
- Cookie-basierte Sessions
- Separate User- und Gast-Sessions
- Session-Validierung über Middleware
- Sichere Session-Konfiguration (httpOnly, secure)

### 3. Error-Handling
- Konsistente Error-Response-Struktur:
```json
{
  "error": true,
  "message": "Fehlerbeschreibung",
  "code": "ERROR_CODE"
}
```

### 4. Database-Schema
```sql
-- Users Tabelle
CREATE TABLE users (
  id INT AUTO_INCREMENT PRIMARY KEY,
  email VARCHAR(255) UNIQUE NOT NULL,
  password VARCHAR(255) NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Todos Tabelle
CREATE TABLE todos (
  id INT AUTO_INCREMENT PRIMARY KEY,
  user_id INT,
  session_id VARCHAR(255),
  title VARCHAR(255) NOT NULL,
  description TEXT,
  completed BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

## Coding Standards

### 1. Dateistruktur
- Ein Modul pro Datei
- CommonJS (require/module.exports)
- Async/Await für asynchrone Operationen
- Proper Error-Handling mit try/catch

### 2. Security Best Practices
- Passwort-Hashing mit bcrypt
- SQL-Injection Prevention (Prepared Statements)
- CORS richtig konfigurieren
- Helmet für Security-Headers
- Input-Validierung und Sanitization

### 3. Database-Patterns
- Connection-Pooling für MariaDB
- Prepared Statements für alle Queries
- Transaction-Handling für kritische Operationen
- Proper Connection-Cleanup

## Neue Module erstellen

### Wenn du neue Route-Dateien erstellst:
1. Erstelle sie im `routes/` Verzeichnis
2. Verwende Express.Router()
3. Implementiere proper Error-Handling
4. Füge Input-Validierung hinzu
5. Registriere Route in server.js

### Wenn du neue Middleware erstellst:
1. Erstelle sie im `middleware/` Verzeichnis
2. Folge Express-Middleware-Pattern (req, res, next)
3. Implementiere proper Error-Handling
4. Dokumentiere Parameter und Verhalten

### Wenn du neue Models erstellst:
1. Erstelle sie im `models/` Verzeichnis
2. Verwende Klassen oder Factory-Functions
3. Kapsele Database-Queries
4. Implementiere CRUD-Operationen

## Environment Variables (.env)
```
DB_HOST=localhost
DB_USER=your_db_user
DB_PASSWORD=your_db_password
DB_NAME=restful_notes
SESSION_SECRET=your_session_secret
NODE_ENV=development
PORT=3000
CORS_ORIGIN=http://localhost:3000
```

## Development Workflow
1. Starte MariaDB-Server
2. Führe Migrations aus (init.sql)
3. Erstelle .env-Datei
4. `npm install` für Dependencies
5. `npm run dev` für Development-Server

## Testing & Debugging
- Verwende Postman/Thunder Client für API-Tests
- Console.log für Request-Debugging
- MariaDB-Logs für Database-Debugging
- Express Error-Handling für Stack-Traces

## Production Considerations
- Environment-spezifische Konfiguration
- Database-Connection-Pooling optimieren
- Session-Store für Production (Redis/Database)
- Proper Logging-System
- Health-Check Endpoints
